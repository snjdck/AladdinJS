
const {decode} = require('utils/text/gb2312');

const xor_tab_datfile = [0x3F08A79B, 0xE25CC287, 0x93D27AB9, 0x20DEA7BF];
const xor_tab_3byte = [0xFC, 0xCF, 0xAB];


function xor3byte(packet, len=packet.length, offset=0){
	for(let i=0; i<len; ++i){
		packet[offset+i] ^= xor_tab_3byte[i % 3];
	}
}

const typeInfo = ['剑', '斧头', '杖', '矛', '弓/弩', '杖', '盾牌', '头盔', '铠甲', '护腿', '护手', '靴子', '翅膀/石头','宠物','一般道具','法术']
const posInfo = ['右手','左手','头盔','铠甲','护腿','护手','护靴','翅膀','辅助','项链','戒指']
const skillInfo = {
	20:'牙突刺',
	21:'升龙击',
	22:'旋风斩',
	23:'天地十字剑',
	19:'地裂斩',
	18:'圣盾防御',
	24:'多重箭',
}

module.exports = function(data){
	const result = {};
	xor3byte(data);
	//console.log(data)
	for(let k=0; k<16; ++k){
		for(let j=0; j<512; ++j){
			let i = j * 84 + k * 512 * 84;
			let offset = i + 30;
			let nameEnd = data.indexOf(0, i);
			if(nameEnd == i)break;
			result[decode(data.slice(i, nameEnd))] = {
				'type': k,
				'typeDesc': typeInfo[k],
				'doubleHand': data[offset],
				'usePos':data.readUInt16BE(offset+3),
				'usePosDesc':posInfo[data.readUInt16BE(offset+3)] || '背包',
				'sizeX':data[offset+6],
				'sizeY':data[offset+7],
				'skill': data[offset+5],
				'skillDesc': skillInfo[data[offset+5]]||data[offset+5].toString(16),
			}
			/*
			console.log('name', decode(data.slice(i, nameEnd)))
			console.log('both hand', data[offset])
			console.log('drop level', data.readUint16BE(offset+1))
			console.log('use pos', posInfo[data.readUint16BE(offset+3)] || '背包')
			console.log('skill', skillInfo[data[offset+5]]||data[offset+5].toString(16))
			console.log('size', data[offset+6], data[offset+7])
			console.log('attack', data[offset+8], data[offset+9])
			console.log('speed', data[offset+13])
			console.log('耐久', data[offset+15])
			if(data[offset+10]){
				console.log('防御率', data[offset+10])
			}
			if(data[offset+11]){
				console.log('防御力', data[offset+11])
			}
			if(data[offset+14]){
				console.log('移动速度', data[offset+14])
			}
			let job = [];
			if(data[i+69])job.push('法师');
			if(data[i+70])job.push(data[i+70] == 2 ? '骑士' : '剑士');
			if(data[i+71])job.push('弓箭手');
			if(data[i+72])job.push('魔剑士');
			if(data[i+73])job.push('圣导师');
			if(data[i+74])job.push('召唤术师');
			console.log('job', job.toString())
			*/
		}
	}
	return result;
}
