'use strict';

const WebGL = require('../WebGL');
const ObjectBucket = require('ds/ObjectBucket');

class DrawUnitBucket extends ObjectBucket
{
	constructor(mapObjCache){
		super();
		this.mapObjCache = mapObjCache;
		this.regKeyFn(getShader, updateShader);
		this.regKeyFn(getMaterialType, updateMaterialType);
		this.regKeyFn(getTexture, updateTexture);
		this.regKeyFn(getVAO, updateVAO);
	}

	newMap(){
		return this.mapObjCache.getOut();
	}
}

function getShader(drawUnit, key){
	let material = key ? drawUnit[key] : drawUnit.material;
	return material.shader;
}

function getMaterialType(drawUnit, key){
	let material = key ? drawUnit[key] : drawUnit.material;
	return material.constructor;
}

function getTexture(drawUnit, key){
	let material = key ? drawUnit[key] : drawUnit.material;
	return material.texture;
}

function getVAO(drawUnit){
	return drawUnit.vao;
}

const guard = (key, fn) => function(value){
	let oldValue = this.get(key);
	if(value == oldValue)return;
	this.set(key, value);
	fn.call(this, value, oldValue);
}

const updateShader = guard('shader', function(value){
	const {gl, programMgr, profileMgr} = WebGL;
	profileMgr.profile3d.shaderSwitchCount++;
	let program = programMgr.useProgram(value);
	this.set('program', program);
	this.set('address_InstanceIDBase', gl.getUniformLocation(program, 'InstanceIDBase'));
})

const updateMaterialType = guard('materialType', function(materialType, oldValue){
	if(materialType.needInitUniformLocationFlag){
		//materialType.needInitUniformLocationFlag = false;
		materialType.initUniformLocation(WebGL.gl, this.get('program'));
	}
	if(oldValue && oldValue.renderState == materialType.renderState)return;
	WebGL.profileMgr.profile3d.stateSwitchCount++;
	WebGL.renderState.merge(materialType.renderState);
})

const updateTexture = guard('texture', function(value){
	const {gl, profileMgr} = WebGL;
	let materialType = this.get('materialType');
	materialType.bindTexture(gl, value);
	profileMgr.profile3d.textureSwitchCount++;
})

const updateVAO = guard('vao', value => {
	WebGL.profileMgr.profile3d.vaoSwitchCount++;
	value.active();
})

module.exports = DrawUnitBucket;
