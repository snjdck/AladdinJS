"use strict";

const WebGL = require('../WebGL');

function batchDraw(vao, uniform, instanceList, updateUniform, isPickMode=false, addressInstanceID=0){
	const {mouseMgr} = WebGL;
	const instanceCountPerDraw = uniform.maxInstanceCount;
	const totalInstanceCount = instanceList.length;
	const drawCount = Math.ceil(totalInstanceCount / instanceCountPerDraw);
	uniform.alloc(totalInstanceCount);
	let instanceIndex = 0;
	for(let _=0; _<drawCount; ++_){
		if(isPickMode){
			uniform.setInts(addressInstanceID, mouseMgr.nextPickID);
		}
		const instanceCount = Math.min(instanceCountPerDraw, totalInstanceCount - instanceIndex);
		for(let i=0; i<instanceCount; ++i){
			const instance = instanceList[instanceIndex+i];
			updateUniform(uniform, instance, i);
			if(isPickMode){
				mouseMgr.pickRegister(instance);
			}
		}
		instanceIndex += instanceCount;
		uniform.upload(instanceCount);
		vao.draw(instanceCount);
	}
	return drawCount;
}

module.exports = batchDraw;