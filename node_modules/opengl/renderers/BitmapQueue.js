'use strict';

const WebGL = require('../WebGL');

class BitmapQueue
{
	constructor(){
		this.currentTexture = null;
		this.currentSet = null;
		this.queue = [];
	}

	clear(){
		this.currentTexture = null;
		this.currentSet = null;
		this.queue.length = 0;
	}

	add(target){
		const texture = target.texture.getRawAsset();
		if(this.currentTexture != texture){
			this.currentTexture = texture;
			this.currentSet = [];
			this.queue.push(this.currentSet);
		}
		this.currentSet.push(target);
	}

	draw(batchDrawFn){
		const {gl, profileMgr:{profile2d}} = WebGL;
		const {queue} = this;
		for(let i=0, n=queue.length; i<n; ++i){
			const list = queue[i];
			const texture = list[0].texture.getRawAsset();
			gl.bindTexture(gl.TEXTURE_2D, texture);
			profile2d.drawCount += batchDrawFn(list);
			profile2d.textureSwitchCount++;
		}
		return this;
	}
}

module.exports = BitmapQueue;
