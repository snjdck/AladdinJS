"use strict";

const WebGL = require('../WebGL');
const {decode} = require("fileformats/images");

class TextureManager{
	constructor(){
		this.textureDict = new Map();
	}

	fetch(name){
		let {textureDict} = this;
		let {assetMgr, gl} = WebGL;
		if(textureDict.has(name)){
			let info = textureDict.get(name);
			return info.asset;
		}
		let info = {name};
		textureDict.set(name, info);
		console.log("--------------",name)
		if(name.endsWith(".tga")){
			assetMgr.loadFile(name).then(data => {
				data = decode(name, data);
				info.asset = createTexture(gl, data.width, data.height, data.data);
			});
		}else{
			assetMgr.loadImage(name).then(_ => {
				info.asset = gl.createDomTexture(name);
			});
		}
	}
}

function createTexture(gl, width, height, imageRawData){
	let texture = gl.createTexture();
	gl.bindTexture(gl.TEXTURE_2D, texture);
	gl.texStorage2D(gl.TEXTURE_2D, 1, gl.RGBA8, width, height);
	gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, imageRawData);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
	//gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
	//gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
	texture.width = width;
	texture.height = height;
	return texture;
}

module.exports = TextureManager;
