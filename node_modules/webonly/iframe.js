'use strict';

function waitEvent(target, event){
	return new Promise(resolve => {
		target.addEventListener(event, resolve, {once:true});
	});
}

function sendMsg(iframe, msgType, msgData){
	return new Promise((resolve, reject) => {
		const {contentWindow} = iframe;
		function onMessage(evt){
			if(evt.source != contentWindow)return;
			const {type, data} = evt.data;
			if(type != msgType)return;
			window.removeEventListener('message', onMessage);
			resolve(data);
		}
		window.addEventListener('message', onMessage);
		contentWindow.postMessage({type:msgType, data:msgData});
	});
}

function handleMsg(handler){
	window.addEventListener('message', async evt => {
		const {type, data} = evt.data;
		evt.source.postMessage({type, data: await handler[type](data)});
	});
}

exports.waitEvent = waitEvent;
exports.sendMsg = sendMsg;
exports.handleMsg = handleMsg;
