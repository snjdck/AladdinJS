
class Stream {
	async close(){
		await this.reader?.cancel();
		await this.writer?.abort();
	}

	async read(readable, handler){
		const reader = readable.getReader();
		this.reader = reader;
		try{
			for(;;){
				const {done, value} = await reader.read();
				if(done)break;
				handler(value);
			}
		}catch(error){
		}finally{
			this.reader = null;
			reader.releaseLock();
		}
	}

	async write(writable, data){
		const writer = writable.getWriter();
		this.writer = writer;
		try{
			await writer.write(data);
		}finally{
			this.writer = null;
			writer.releaseLock();
		}
	}
}

exports.Stream = Stream;
