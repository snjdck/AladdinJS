
const escape = (function(){
	let dict = {"<":"&lt;", ">":"&gt;", "&":"&amp;"};
	let _replace = v => dict[v];
	let pattern = /[<>&]/g;
	return v => v.replace(pattern, _replace);
})();

const template = ((_eval, pattern, builtin) => function(input){
	let stack = [];
	let code = [];
	for(;;){
		let info = pattern.exec(input);
		let head = info ? input.slice(0, info.index) : input;
		if( head)code.push(`yield ${JSON.stringify(head)};`);
		if(!info)break;
		input = input.slice(info.index + info[0].length);
		let text = info[2];
		switch(info[1]){
			case "=": text = `escape(String(${text}))`;//fallthrough
			case "!": text = `yield ${text};`;break;
			case "*": text = `if(typeof ${text} != "undefined"){for(let _ of (Array.isArray(${text})?(${text}):(${text}?[${text}]:[]))){with(_){`;stack.push(info[1]);break;
			case "#": text = `yield ${text}(Array.from(function*(){`;stack.push(info[1]);break;
			case "/":{
				switch(stack.pop()){
					case "*": text = "}}}";break;
					case "#": text = "}()).join(''));";break;
					default : throw new Error();
				}
				break;
			}
		}
		code.push(text);
	}
	let handler = _eval(`(function*(){with(this){${code.join("\n")}}})`);
	return (self=null) => Array.from(handler.call(Object.create(self, builtin))).join("");
})(eval, /<%(=|!|#|\*|\/|)([^]*?)%>/, {escape:{value:escape}});

module.exports = {
	template,
	escape
};