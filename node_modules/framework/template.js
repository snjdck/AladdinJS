"use strict";

function _replace(input, index){
	switch(input){
		case "<": return "&lt;";
		case ">": return "&gt;";
		case "&": return "&amp;";
	}
}
function escapeHtmlChar(input){
	return input.replace(/[<>&]/g, _replace);
}

function quote(value){
	return `"${value.replace(/"/g, '\\"')}"`;
}

function template(input){
	let queue = [`let $out = [];`, `with(context){`];
	input = input.trim();
	while(input.length > 0){
		let info = /<%(.*?)%>/.exec(input);
		if(!info){
			queue.push(`$out.push(${quote(input)});`);
			break;
		}
		let head = input.slice(0, info.index).trimRight();
		if(head){
			queue.push(`$out.push(${quote(head)});`);
		}
		input = input.slice(info.index + info[0].length).trimLeft();
		let text = info[1];
		if(/^[=!]/.test(text)){
			let escapeFlag = text.startsWith("=");
			text = text.slice(1);
			if(escapeFlag){
				text = `escapeHtmlChar(String(${text}))`;
			}
			queue.push(`$out.push(${text});`);
		}else{
			queue.push(text);
		}
	}
	queue.push(`}`, `return $out.join("");`);
	
	let code = queue.join("\n");
	console.log(code)
	let handler = Function("context", code);
	return context => handler(Object.assign({escapeHtmlChar}, context));
}

let val = template(`
		<h1 class="alex"><%! name %></h1><h1><%= sex %></h1><%! name%><br>
	<% for(let i=0;i<5;++i){ %>
	<% for(let j=0;j<3;++j){ %>
		<%  %>
		<span><%! i+","+j %></span>
	<% }} %>


`)({name:"<p>alex</p>",sex:"male"});
console.log(val)