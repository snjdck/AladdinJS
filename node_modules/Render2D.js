"use strict";

const {VertexArray2D} = require("./vertexarrays");
const {UniformBuffer} = require("./uniformbuffers");
const batchDraw = require("./renderers/batchDraw");

const MAX_INSTANCE_COUNT = 10;

class Render2D
{
	constructor(gl){
		this.gl = gl;
		this.vao = new VertexArray2D();
		this.uniformBuffer = new UniformBuffer(6, 1, MAX_INSTANCE_COUNT);
		this.invalidateFlag = true;
		this.targetList = [];
		this.activeTexture = null;
		this.mode = null;
	}

	isPickMode(){
		return this.mode == "pick";
	}

	viewport(width, height){
		this.uniformBuffer.setFloats(0, 2 / width, -2 / height);
	}

	invalidate(){
		this.invalidateFlag = true;
	}

	drawBegin(){
		const {gl, vao, uniformBuffer} = this;

		let program = gl.programMgr.fetch(`shader2d&${this.mode}`);
		gl.useProgram(program);

		uniformBuffer.active(gl);
		vao.active(gl);

		gl.activeTexture(gl.TEXTURE0);
		gl.uniform1i(gl.getUniformLocation(program, "sampler0"), 0);

		gl.disable(gl.DEPTH_TEST);
		if(this.isPickMode()){
			gl.disable(gl.BLEND);
		}else{
			gl.enable(gl.BLEND);
			gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
		}
	}

	drawBitmap(target){
		let texture = target.texture.getRawAsset(this.gl);
		if(texture != this.activeTexture){
			this.submit();
		}
		this.targetList.push(target);
		this.activeTexture = texture;
	}

	submit(){
		if(this.targetList.length <= 0)return;
		if(this.invalidateFlag){
			this.drawBegin();
			this.invalidateFlag = false;
		}
		const {gl, vao, uniformBuffer, targetList} = this;
		gl.bindTexture(gl.TEXTURE_2D, this.activeTexture);
		let drawCount = batchDraw(gl, vao, uniformBuffer, targetList, MAX_INSTANCE_COUNT, this.updateUniform, this.isPickMode(), 2);
		
		gl.profileMgr.profile2d.drawCount += drawCount;
		gl.profileMgr.profile2d.textureSwitchCount++;

		targetList.length = 0;
		this.activeTexture = null;
	}

	updateUniform(uniformBuffer, target, index){
		let offset = 4 + 24 * index;
		const {worldTransform, texture, width, height} = target;
		
		worldTransform.copyToArray(uniformBuffer.floatView, offset);
		uniformBuffer.setFloatv(offset+8 , texture.xyuvMul);
		uniformBuffer.setFloatv(offset+12, texture.xyuvAdd);
		uniformBuffer.setFloatv(offset+20, texture.scale9grid);
		uniformBuffer.setFloats(offset+16, width, texture.width, height, texture.height);
	}
}

module.exports = Render2D;