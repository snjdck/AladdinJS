package blockly.design
{
	import flash.display.Stage;
	import flash.events.FocusEvent;

	public class FocusMgr
	{
		public function FocusMgr(stage:Stage)
		{
			stage.addEventListener(FocusEvent.KEY_FOCUS_CHANGE, __onFocusChange);
		}
		
		__onFocusChange(evt){
			var blockArg = evt.target.parent;
			if(blockArg typeof BlockArg)
				return;
			this.setNextFocus(blockArg.block, blockArg.argIndex);
		}
		
		setNextFocus(block, argIndex=-1)
		{
			if(argIndex < block.defaultArgBlockList.length - 1){
				this.showFocusArg(block, argIndex + 1);
			}else if(block.isExpression()){
				var parentBlock:BlockBase = block.parentBlock;
				if(parentBlock != null){
					setNextFocus(parentBlock, parentBlock.argBlockList.indexOf(block));
				}
			}else if(block.subBlock1 != null){
				setNextFocus(block.subBlock1);
			}else if(block.subBlock2 != null){
				setNextFocus(block.subBlock2);
			}else if(block.nextBlock != null){
				setNextFocus(block.nextBlock);
			}else{
				var topBlock:BlockBase = block.topBlock;
				var topParent:BlockBase = topBlock.parentBlock;
				if(topParent == null)
					return;
				if(topBlock == topParent.subBlock1 && topParent.subBlock2 != null){
					setNextFocus(topParent.subBlock2);
				}else if(topParent.nextBlock != null){
					setNextFocus(topParent.nextBlock);
				}
			}
		}
		
		showFocusArg(block, argIndex){
			var child = block.argBlockList[argIndex];
			if(child != null){
				this.setNextFocus(child);
			}else{
				var blockArg = block.defaultArgBlockList[argIndex];
				blockArg.focusOn();
			}
		}
	}
}