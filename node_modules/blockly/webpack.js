// /\:*?"<>|
const fs = require('fs');
const {dirname, join, sep} = require('path');
const addExt = v => v.endsWith('.js') ? v : v + '.js';
const addTab = v => v.replace(/\n|^/g, '$&\t');
const pattern = /(?<=^|\W)require\s*\(\s*("|')(.+?)\1\s*\)/g;
const fileList = [];

function load(dir, name){
	const file = join(dir, addExt(name));
	let index = fileList.findIndex(v => v.file == file);
	if(index < 0){
		index = fileList.length;
		const info = {file};
		fileList.push(info);
		dir = dirname(file);
		info.data = fs.readFileSync(file, 'utf8')
			.replace(pattern, (_0, _1, _2) =>
			`__webpack_require__(/* ${_2} */ ${load(dir, _2)})`
		);
	}
	return index;
}

const genOutput = modules => `'use strict';
(function(modules){
	const installedModules = {};
	function __webpack_require__(moduleId){
		if(installedModules[moduleId]){
			return installedModules[moduleId].exports;
		}
		const module = installedModules[moduleId] = {
			i: moduleId,
			l: false,
			exports: {}
		};
		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
		module.l = true;
		return module.exports;
	}
	return __webpack_require__(0);
})([${
modules.map((v, i) => `function(module, exports, __webpack_require__){//${i}, ${v.file}\n${addTab(v.data)}\n}`)
}]);`;

load(process.cwd(), process.argv[2]);
fs.writeFileSync('bundle.js', genOutput(fileList));
