"use strict";

function batchDraw(gl, vao, uniform, instanceList, instanceCountPerDraw, updateUniform, isPickMode=false, addressInstanceID=0){
	const totalInstanceCount = instanceList.length;
	const drawCount = Math.ceil(totalInstanceCount / instanceCountPerDraw);
	let instanceIndex = 0;
	for(let _=0; _<drawCount; ++_){
		if(isPickMode){
			uniform.setInts(addressInstanceID, gl.mouseMgr.nextPickID);
		}
		const instanceCount = Math.min(instanceCountPerDraw, totalInstanceCount - instanceIndex);
		for(let i=0; i<instanceCount; ++i){
			const instance = instanceList[instanceIndex+i];
			updateUniform(uniform, instance, i);
			if(isPickMode){
				gl.mouseMgr.pickRegister(instance);
			}
		}
		instanceIndex += instanceCount;
		uniform.upload(gl, instanceCount);
		vao.draw(gl, instanceCount);
	}
	return drawCount;
}

module.exports = batchDraw;