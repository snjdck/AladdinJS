<style>
body{
	margin: 0;
}
.table {
	align-items: center;
	justify-items: center;
	display: grid;
}
.table>* {
	border: 1px groove;
	width: 100%;
	height: 100%;
	display: flex;
	align-items: center;
	justify-content: center;
}
.table>:first-child {
	background-color: white;

	flex-direction: column;
	justify-content: space-evenly;

	z-index: 1;

	position: sticky;
	top:0px;
	left:0px;
}
.table>.row {
	background-color: burlywood;

	position: sticky;
	top:0px;

	margin: 0 1rem;
}
.table>.column {
	background-color: burlywood;

	position: sticky;
	left:0px;
}
input[type="text"], input[type="number"]{
	text-align: center;
	border: none;
}
input[type="text"]:focus, input[type="number"]:focus{
	outline: 1px dashed;
}
</style>

<script>

document.addEventListener('DOMContentLoaded', () => loadData({
	columns:['A','B','C','D'],
	types:[{type:'boolean'}, {type:'option', value:['A','B',{label:'C',value:3}],default:'A'}, {type:'number',width:'3rem',default:0}, {type:'text',width:'10rem',default:''}],
	rows:['1','2','3','4']
}));

function loadData({columns, types, rows, values}){
	if(!values){
		values = rows.map(() => []);
	}else{
		while(values.length < rows.length){
			values.push([]);
		}
	}
	document.body.innerHTML = '';

	const div = document.createElement('div');
	div.setAttribute('class', 'table');
	div.setAttribute('style', `grid-template-columns: 100px repeat(${columns.length}, max-content);grid-auto-rows: 50px;`);
	document.body.appendChild(div);

	div.appendChild(document.createElement('div'));

	const openBtn = div.firstChild.appendChild(document.createElement('button'));
	openBtn.textContent = 'Open';
	openBtn.addEventListener('click', async evt => loadData(await openFile()));

	const saveBtn = div.firstChild.appendChild(document.createElement('button'));
	saveBtn.textContent = 'Save';
	saveBtn.addEventListener('click', async evt => {
		await saveFile('data.json', JSON.stringify({columns, types, rows, values}));
		alert('保存成功');
	});

	for(let i=0; i<columns.length; ++i){
		let child = div.appendChild(document.createElement('div'));
		child.setAttribute('class', 'row');
		child.textContent = columns[i];
	}
	for(let j=0; j<rows.length; ++j){
		let child = div.appendChild(document.createElement('div'));
		child.setAttribute('class', 'column');
		child.textContent = rows[j];
		for(let i=0; i<columns.length; ++i){
			child = div.appendChild(document.createElement('div'));
			if(types[i].type == 'number' || types[i].type == 'text'){
				let input = child.appendChild(document.createElement('input'));
				input.setAttribute('type', types[i].type);
				if(types[i].width){
					input.style.width = types[i].width;
				}
				input.value = values[j][i] ?? types[i].default;
				input.readOnly = true;
				input.addEventListener('dblclick', evt => input.readOnly = false);
				input.addEventListener('blur', evt => input.readOnly = true);
				input.addEventListener('change', evt => values[j][i] = evt.target.value);
				continue;
			}
			if(types[i].type == 'boolean'){
				let input = child.appendChild(document.createElement('input'));
				input.setAttribute('type', 'checkbox');
				input.checked = values[j][i];
				input.addEventListener('change', evt => values[j][i] = evt.target.checked);
				continue;
			}
			if(types[i].type == 'option'){
				let select = child.appendChild(document.createElement('select'));
				for(let v of types[i].value){
					let option = select.appendChild(document.createElement('option'));
					if(typeof v == 'string'){
						option.textContent = v;
					}else{
						option.textContent = v.label;
						option.setAttribute('value', v.value);
					}
				}
				select.value = values[j][i] ?? types[i].default;
				select.addEventListener('change', evt => values[j][i] = evt.target.value);
				continue;
			}
		}
	}
}

async function saveFile(name, data){
	let handler = await showSaveFilePicker({
		excludeAcceptAllOption:true,
		id:'save',
		startIn:'documents',
		suggestedName:name,
		types:[{accept:{'application/json':['.json']}}]
	});
	let stream = await handler.createWritable();
	try{
		await stream.write(data);
	}finally{
		await stream.close();
	}
}

async function openFile(){
	let [handler] = await showOpenFilePicker({
		excludeAcceptAllOption:true,
		id:'open',
		startIn:'documents',
		types:[{accept:{'application/json':['.json']}}]
	});
	let file = await handler.getFile();
	return JSON.parse(await file.text());
}

</script>