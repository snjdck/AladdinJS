'use strict';

const {URL}= require('url');
const load = require('net/load');

function loadPage(url, handler, excludeList, visited, parentURL){
	const root = new URL(url).origin;
	visited.add(url);
	load(url).then(html => (handler(html, url), Array.from(new Set(
			(html.match(/href=("|').+?\1/g) || [])
			.map(v => v.slice(6, -1))
			.filter(v => v.startsWith(root) || v.startsWith('/'))
			.map(v => v.startsWith('/') ? v : v.slice(root.length))
			.filter(v => v.length > 1 && !v.startsWith('//'))
			.filter(v => !excludeList.some(dir => v == `/${dir}` || v.startsWith(`/${dir}/`)))
			.map(v => root + v)
			.filter(v => !visited.has(v))
		)).forEach(v => loadPage(v, handler, excludeList, visited, url))
	)).catch(error => console.error('error', parentURL, url));
}

exports.loadPage = loadPage;
