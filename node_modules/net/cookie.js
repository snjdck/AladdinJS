
const cookieDict = Object.create(null);

function sendCookie(request, {hostname:host, pathname:path}){
	let cookie = cookieDict[host];
	if(!cookie)return;
	let now = Date.now();
	let value = Object.entries(cookie).filter(
		([k, v]) => path.startsWith(v.path) && now < v.expires
	).map(
		([k, v]) => `${k}=${v.value}`
	).join('; ');
	if(value)request.setHeader('Cookie', value);
}

function recvCookie(response, {hostname:host}){
	let set_cookie = response.headers['set-cookie'];
	if(!Array.isArray(set_cookie))return;
	let cookie = parseCookie(set_cookie.map(v => v.split('; ').map(v => v.split('='))));
	if(host in cookieDict){
		Object.assign(cookieDict[host], cookie);
	}else{
		cookieDict[host] = cookie;
	}
}

function parseCookie(set_cookie){
	let cookie = Object.create(null);
	for(let item of set_cookie){
		let [name, value] = item.shift();
		cookie[name] = value = {value};
		for(let [k, v] of item){
			if(v === undefined){
				v = true;
			}else if(k == 'max-age'){
				k = 'expires';
				v = Date.now() + 1000 * v;
			}else if(k == 'expires'){
				v = Date.parse(v);
			}
			value[k] = v;
		}
	}
	return cookie;
}

exports.sendCookie = sendCookie;
exports.recvCookie = recvCookie;
