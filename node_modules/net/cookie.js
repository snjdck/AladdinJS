
const cookieDict = Object.create(null);

function getCookie({hostname:host, pathname:path}){
	let cookie = cookieDict[host];
	if(!cookie)return;
	let now = Date.now();
	return Object.entries(cookie).filter(
		([k, v]) => path.startsWith(v.path) && now < v.expires
	).map(
		([k, v]) => `${k}=${v.value}`
	).join('; ');
}

function setCookie({hostname:host}, value){
	if(!Array.isArray(value))return;
	let cookie = parseCookie(value.map(v => v.split('; ').map(v => v.split('='))));
	if(host in cookieDict){
		Object.assign(cookieDict[host], cookie);
	}else{
		cookieDict[host] = cookie;
	}
}

function parseCookie(set_cookie){
	let cookie = Object.create(null);
	for(let item of set_cookie){
		let [name, value] = item.shift();
		cookie[name] = value = {value};
		for(let [k, v] of item){
			if(v === undefined){
				v = true;
			}else if(k == 'max-age'){
				k = 'expires';
				v = Date.now() + 1000 * v;
			}else if(k == 'expires'){
				v = Date.parse(v);
			}
			value[k] = v;
		}
	}
	return cookie;
}

exports.getCookie = getCookie;
exports.setCookie = setCookie;
