'use strict';

const {URL} = require('url');
const {sendCookie, recvCookie} = require('./cookie');

function listenEvt(target, callback){
	let result = [];
	target.on('data', chunk => result.push(chunk));
	target.on('end', () => callback(Buffer.concat(result)));
}

const castType = function(){
	const self = v => v;
	const text = v => v.toString();
	const json = v => JSON.parse(v.toString());
	const dict = {text, json};
	return v => dict[v] || self;
}()

function load(url, {method, body, headers, responseType='text'}={}){
	return new Promise(function(resolve, reject){
		const info = new URL(url);
		const http = require(info.protocol.slice(0, -1));
		const options = {host: info.hostname, path: (info.pathname + info.search), method, port: info.port};
		const request = http.request(options, response => {
			if(response.statusCode == 200){
				recvCookie(response, info);
				listenEvt(response, resolve);
			}else{
				reject(response.statusMessage);
			}
		});
		for(let k in headers)request.setHeader(k, headers[k]);
		sendCookie(request, info);
		request.on('error', reject);
		request.end(body);
	}).then(castType(responseType));
}

module.exports = load;
