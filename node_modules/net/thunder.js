'use strict';

/*
code 206

->RANGE:bytes=44445555-
<-Content-Range=bytes 44445555-66667777

Last-Modified
ETag
If-Match
If-Modified-Since 
If-Range
//*/

const load = require('./load');
const pageSize = 10 * 1024;

const toRange = ([from, to]) => `bytes=${from}-${to-1}`;

async function download(url){
	const headers = await load(url, {method:'HEAD'});
	const contentLength = parseInt(headers['content-length']);
	const threadCount = Math.ceil(contentLength / pageSize);
	const rangeList = [];
	for(let i=0; i<threadCount; ++i){
		const from = pageSize * i;
		const to = Math.min(contentLength, pageSize * (i + 1));
		rangeList.push([from, to]);
	}
	const promiseList = rangeList.map(toRange).map(Range => load(url, {headers:{Range}}));
	return Buffer.concat(await Promise.all(promiseList));
}

async function test(){
	const fs = require('fs');
	const {basename} = require('path');
	const url = '';
	let buffer = await download(url)
	console.log(buffer.length == 30354);
	require('fs').writeFileSync(basename(url), buffer);
}

module.exports = download;
