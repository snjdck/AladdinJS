'use strict';
//path-to-regexp
const {URL} = require('url');

module.exports = info => {
	const {host, port, protocol, options} = Object.assign({
		port: 80,
		host: '0.0.0.0',
		protocol: 'http',
	}, info);
	require(protocol).createServer(options, (request, response) => {
		response.setHeader('Access-Control-Allow-Origin', '*');
		response.setHeader('Content-Type', 'text/event-stream');
		response.setHeader('Cache-Control', 'no-cache');
		response.setHeader('Connection', 'keep-alive');
		dispatch(request, response);
	}).listen(port, host);
	const handlerMap = new Map();
	function dispatch(request, response){
		const {pathname:path, searchParams:params} = new URL(request.url, protocol + '://' + request.headers.host);
		if(handlerMap.has(path)){
			const handler = handlerMap.get(path);
			const onClose = handler(response, params);
			if(onClose)request.on('close', onClose);
		}else{
			response.statusCode = 404;
			response.end();
		}
	}
	return function(path, handler){
		handlerMap.set(path, handler);
	}
}
