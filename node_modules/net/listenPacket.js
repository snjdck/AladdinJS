'use strict';

function newDataHandler(Packet, callback){
	let buffer = Buffer.alloc(0);
	return data => {
		buffer = Buffer.concat([buffer, data]);
		let offset = 0;
		for(;;){
			let packet = Packet.cut(buffer, offset);
			if(!packet)break;
			offset += packet.length;
			callback(Packet.decode(packet));
		}
		if(offset <= 0)return;
		buffer = buffer.slice(offset);
	}
}

function listenPacket(socket, Packet, callback){
	const onData = newDataHandler(Packet, callback);
	socket.on('data', onData);
	return () => socket.off('data', onData);
}

module.exports = listenPacket;
