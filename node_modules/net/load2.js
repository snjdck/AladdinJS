'use strict';

const {URL} = require('url');

function listenEvt(target, callback){
	let result = [];
	target.on('data', chunk => result.push(chunk));
	target.on('end', () => callback(Buffer.concat(result)));
}

const castType = responseType => v => {
	if(responseType == 'text')return v.toString();
	if(responseType == 'json')return JSON.parse(v.toString());
	return v;
}

function load(url, {method, body, headers, responseType='text'}={}){
	return new Promise(function(resolve, reject){
		const info = new URL(url);
		const http = require(info.protocol.slice(0, -1));
		const options = {host: info.host, path: (info.pathname + info.search), method};
		const request = http.request(options, response => response.statusCode == 200 ? listenEvt(response, resolve) : reject(response.statusMessage));
		for(let k in headers)request.setHeader(k, headers[k]);
		request.on('error', reject);
		if(body)request.write(body);
		request.end();
	}).then(castType(responseType));
}

module.exports = load;
