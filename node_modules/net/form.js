
const load = require('./load');

const BOUNDARY = '----WebKitFormBoundaryJogJuHTlZmoELETx';

const FORM_BEGIN = Buffer.from(`--${BOUNDARY}\n`);
const FORM_END = Buffer.from(`--${BOUNDARY}--`);
const FORM_RETURN = Buffer.from('\n');

const contentType = `multipart/form-data; boundary=${BOUNDARY}`;
function newFormBody(form){
	let list = [];
	for(let k in form){
		let v = form[k];
		list.push(FORM_BEGIN);
		if(Buffer.isBuffer(v)){
			list.push(
				Buffer.from(`Content-Disposition: form-data; name="${k}"; filename="blob"\nContent-Type: image/jpeg\n\n`),
				v, FORM_RETURN);
		}else{
			list.push(Buffer.from(`Content-Disposition: form-data; name="${k}"\n\n${v}\n`));
		}
	}
	list.push(FORM_END);
	return Buffer.concat(list);
}

exports.contentType = contentType;
exports.newFormBody = newFormBody;

exports.post = function(url, options){
	let method = 'POST';
	let headers = options && options.headers;
	let body = newFormBody(options.body);
	headers = {...headers, 'Content-Type': contentType};
	return load(url, {...options, method, headers, body});
}