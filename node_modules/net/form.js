
const load = require('./load');

const BOUNDARY = '----WebKitFormBoundaryJogJuHTlZmoELETx';
const contentType = `multipart/form-data; boundary=${BOUNDARY}`;
const newFormBody = function(FORM_BEGIN, FORM_END, FORM_RETURN){
	function* gen(form){
		for(let k in form){
			let v = form[k];
			yield FORM_BEGIN;
			if(Buffer.isBuffer(v)){
				yield Buffer.from(`Content-Disposition: form-data; name="${k}"; filename="blob"\nContent-Type: image/jpeg\n\n`);
				yield v;
				yield FORM_RETURN;
			}else{
				yield Buffer.from(`Content-Disposition: form-data; name="${k}"\n\n${v}\n`);
			}
		}
		yield FORM_END;
	}
	return form => Buffer.concat(Array.from(gen(form)));
}(Buffer.from(`--${BOUNDARY}\n`), Buffer.from(`--${BOUNDARY}--`), Buffer.from('\n'));

exports.contentType = contentType;
exports.newFormBody = newFormBody;

exports.post = function(url, options){
	let method = 'POST';
	let headers = options && options.headers;
	let body = newFormBody(options.body);
	headers = {...headers, 'Content-Type': contentType};
	return load(url, {...options, method, headers, body});
}