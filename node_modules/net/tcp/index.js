'use strict';

const listenPacket = require('../listenPacket');
const {LoopRange} = require('../../utils/counter');
const {waitWhen} = require('../../utils/events');

module.exports = function(socket, Packet, codec, timeout=10000){
	listenPacket(socket, Packet, ({reqId, msgId, payload}) => {
		const result = payload && codec.decode(payload);
		if(reqId > 0)return socket.emit('packet', reqId, result);
		socket.emit('notify', msgId, result);
	});
	const nextReqId = LoopRange(0xFFFF);
	return (msgId, payload, waitFlag=true) => {
		const packet = new Packet(msgId, payload && codec.encode(payload));
		packet.reqId = nextReqId() + 1;
		socket.write(packet.toBytes());
		if(!waitFlag)return;
		return waitWhen(socket, 'packet', timeout, (reqId, payload) => packet.reqId === reqId && payload);
	}
}
