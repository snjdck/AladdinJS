
const listenPacket = require('../listenPacket');
const doAsyncWait = require('../doAsyncWait');

const request = (nextReqId => (socket, codec, timeout, packet) => {
	packet.reqId = nextReqId();
	socket.write(packet.toBytes(codec.encode));
	return doAsyncWait(socket, 'packet', timeout,
		({reqId}) => reqId === packet.reqId,
		({payload}) => payload && codec.decode(payload)
	);
})((reqId => () => reqId = reqId % 0xFFFF + 1)(0));

module.exports = function(socket, Packet, codec='json', timeout=10){
	codec = require(`../codec/${codec}`);
	listenPacket(socket, Packet);
	socket.on('packet', ({reqId, msgId, payload}) => {
		if(reqId !== 0)return;
		socket.emit('notify', msgId, payload && codec.decode(payload));
	});
	return (...args) => request(socket, codec, timeout, new Packet(...args));
};
