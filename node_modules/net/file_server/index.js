'use strict';

const http = require('http');
const fs = require('fs');
const path = require('path');
const url = require('url');
const mime = require('./mime');
const networkInterface = require('../networkInterface');

const findContentType = extName => (extName in mime) ? mime[extName] : 'unknow';
const redirect = pathname => (pathname != '/') ? pathname : '/index.html';

module.exports = (directory, port=0) => http.createServer(function(request, response){
	const extName = path.extname(request.url).slice(1);
	const pathname = url.parse(request.url).pathname;
	const filePath = directory + redirect(pathname);
	console.log(request.url, filePath);
	fs.readFile(filePath, function(error, data){
		if(error != null){
			response.statusCode = 404;
		}else{
			response.setHeader('Content-Type', findContentType(extName));
			response.setHeader('Content-Length', data.length);
			response.write(data);
		}
		response.end();
	});
}).on('listening', function(){
	console.log(this.address());
}).listen(port, networkInterface());
