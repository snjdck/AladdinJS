'use strict';

const {readFile} = require('fs');
const {extname} = require('path');
const url = require('url');
const mime = require('./mime');
const networkInterface = require('../networkInterface');

const findContentType = extName => (extName in mime) ? mime[extName] : 'unknow';
const redirect = pathname => (pathname != '/') ? pathname : '/index.html';

module.exports = (directory, port, host, options, http='http') => require(http).createServer(options, (request, response) => {
	let handler = HANDLER[request.method];
	if(handler)handler(directory, request, response);
	else respond404(response);
}).on('listening', function(){
	console.log(this.address());
}).listen(port, host || networkInterface());

const respond404 = response => {
	response.statusCode = 404;
	response.end();
}

const HANDLER = Object.create(null);

HANDLER.GET = function(directory, request, response){
	const {pathname} = url.parse(request.url);
	const filePath = directory + redirect(pathname);
	console.log(request.url, filePath);
	readFile(filePath, function(error, data){
		if(error != null){
			respond404(response);
			return;
		}
		response.setHeader('Content-Type', findContentType(extname(filePath).slice(1)));
		response.setHeader('Content-Length', data.length);
		response.write(data);
		response.end();
	});
}

HANDLER.POST = function(directory, request, response){
	respond404(response);
}
