//http://www.beiwo888.com/
//http://www.chchzhan.com/forum.php?mod=forumdisplay&fid=56&page=2
const load = require('../net/load');

const toPromise = fn => new Promise(resolve => fn(resolve));
const match = (text, pattern, mapFn) => text.match(new RegExp(pattern, 'g')).map(v => mapFn(new RegExp(pattern).exec(v)));

function listen(fn){
	process.stdin.on('data', data => {
		process.stdin.removeAllListeners('data');
		data = data.toString().trim();
		if(data == 'exit')process.exit();
		fn(data);
	});
}

const pattern = /<a href="(.+?)" onclick="atarget\(this\)" class="s xst">《(.+?)》.+?<\/a>/.source;
const link = /<a href="(.+?)" target="_blank">\1<\/a>/.source;

async function main(){
	let data = await load('http://www.chchzhan.com/forum-56-1.html');
	let list = match(data, pattern, v => v.slice(1, 3));
	console.log(list.map((v, i) => `${i}.${v[1]}`).join('\n'));
	for(let index;;){
		do{
			console.log('choose index:');
			index = Number(await toPromise(listen));
		}while(isNaN(index) || index < 0 || index >= list.length);
		console.log(`fetch ${list[index][1]} from ${list[index][0]}`);
		data = await load(list[index][0]);
		let links = match(data, link, v => v[1]);
		console.log(links.join('\n'));
		if(links.some(v => v.includes('pan.baidu.com'))){
			console.log('网盘', data.match(/提取码.+/)[0])
		}
	}
}

main();



