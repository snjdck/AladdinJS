'use strict';

const load = require('../net/load');
const {TaskExecutor, execList} = require('../utils/task');
const fs = require('fs');
const {basename} = require('path');

const root = '';
const executor = execList(TaskExecutor(20), async file => fs.writeFileSync(basename(file), await load(file)));

async function download(code, page=1){
	const text = await load(`${root}/album/${code}/?page=${page}`);
	const title = /<title>(.+?)<\/title>/.exec(text)[1].slice(0, -24);
	const fileList = text.match(/<img src="\/media\/photos\/(\d+)\.jpg" alt=""  id="album_photo_\1" \/>/g).join('').match(/\/media\/photos\/\d+\.jpg/g).map(v => root+v);
	const maxPage = Math.ceil(/of <strong>(\d+)<\/strong>/.exec(text)[1] / 20);
	console.log(code, title, maxPage, page);
	if(!fs.existsSync(title))fs.mkdirSync(title);
	process.chdir(title);
	await executor(fileList.filter(file => !fs.existsSync(basename(file))));
	process.chdir('..');
	if(page >= maxPage)return;
	await download(code, page+1);
}

async function main(){
}

main();
