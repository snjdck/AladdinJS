
const load = require('../net/load');

const toPromise = fn => new Promise(resolve => fn(resolve));
const match = (text, pattern, mapFn) => text.match(new RegExp(pattern, 'g')).map(v => mapFn(new RegExp(pattern).exec(v)));

function listen(fn){
	process.stdin.on('data', data => {
		process.stdin.removeAllListeners('data');
		data = data.toString().trim();
		if(data == 'exit')process.exit();
		fn(data);
	});
}

function site_factory({
	website,
	linkPattern,
	search,
	id2url,
	varPattern,
	varSplitPattern,
}){
	function fetchLinks(data){
		let dict = Object.create(null);
		match(data, linkPattern, v => v.slice(0, 2)).forEach(v => dict[v[1]] = v[0]);
		return Object.entries(dict).sort((a, b) => b[0] - a[0]).map(v => v[1]);
	}
	return async function(){
		const data = await load(website);
		console.log(fetchLinks(data));
		for(;;){
			console.log('input vod number:');
			const index = await toPromise(listen);
			if(/search:/.test(index)){
				const key = /search:\s*(.+)/.exec(index)[1];
				const data = await load(...search(key));
				console.log(fetchLinks(data));
				continue;
			}
			const data = (await load(id2url(index))).toString();
			const result = new RegExp(varPattern).exec(data);
			if(result){
				const list = result[1].match(new RegExp(varSplitPattern, 'g')).map(v => v.slice(v.indexOf('$')+1, -1));
				console.log(list.join('\n'));
			}
		}
	}
}
//*
site_factory({
	website: 'https://www.993dy.com',
	linkPattern: /<a href="\/vod-detail-id-(\d+)\.html".+?>/.source,
	search: key => ['https://www.993dy.com/index.php?m=vod-search', {search:{wd:key}}],
	id2url: id => `https://www.993dy.com/vod-detail-id-${id}.html`,
	varPattern: 'var downurls="(.+?)";',
	varSplitPattern: '.+?#',
})();
//*/
/*
site_factory({
	website: 'http://www.beiwo888.com',
	linkPattern: /<a href="\/vod\/(\d+)\/".+?<\/a>/.source,
	search: key => ['http://www.beiwo888.com/index.php?s=vod-search', {search:{typeid:2,wd:key}}],
	id2url: id => `http://www.beiwo888.com/vod/${id}/`,
	varPattern: 'var GvodUrls3 = "(.+?)";',
	varSplitPattern: '.+?\\$###',
})();
//*/
/*
site_factory({
	website: 'https://www.12tv.cc',
	linkPattern: /<a href="\/vod\/(\d+)\.html".+?<\/a>/.source,
	search: key => ['https://www.12tv.cc/index.php?s=vod-search', {search:{wd:key}}],
	id2url: id => `https://www.12tv.cc/vod/${id}.html`,
	varPattern: '<div class="sidecon">([^]+?)</ul>',
	varSplitPattern: '<a .+?<',
})();
//*/



