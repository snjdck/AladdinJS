'use strict';

const load = require('../net/load');

const {sha1, md5} = function(crypto){
	const sha1 = (k, v) => crypto.createHmac('sha1', k).update(v).digest('base64');
	const md5 = v => crypto.createHash('md5').update(v).digest('base64');
	return {sha1, md5};
}(require('crypto'));

function OSS(region, bucket, AccessKeyId, AccessKeySecret){
	async function put(name, data){
		const method = 'PUT';
		const headers = {
			'content-type': 'text/plain',
			'content-md5': md5(data),
			'x-oss-date': new Date().toUTCString(),
		};
		const stringToSign = [
			method,
			headers['content-md5'],
			headers['content-type'],
			headers['x-oss-date'],
			...Object.keys(headers).filter(k => k.startsWith('x-oss-')).sort().map(k => `${k}:${headers[k]}`),
			`/${bucket}/${Buffer.from(name).toString('latin1')}`
		].join('\n');
		headers.authorization = `OSS ${AccessKeyId}:${sha1(AccessKeySecret, stringToSign)}`;
		const url = `http://${bucket}.${region}.aliyuncs.com/${name}`;
		await load(url, {method, headers, body: data});
		return url;
	}
	return {put};
}
