'use strict';

function showIP(){
	console.group('IP:');
	for(let [key, value] of Object.entries(require('os').networkInterfaces())){
		value = value.filter(({family, internal}) => !internal && family == 'IPv4');
		if(value.length > 0){
			console.log(key, value.map(v => v.address).join(' '));
		}
	}
	console.groupEnd();
}

const print = (status => (code, count, nCodes) => {
	if(code in status){
		status[code]++;
	}else{
		status[code] = 1;
	}
	if(status[code] < count){
		console.log(Object.fromEntries(Object.entries(status).filter(e => e[1] < count)));
		return;
	}
	console.log(`编号: ${code} 已完成 ${count} 次`);
	if(Object.values(status).filter(v => v == count).length == nCodes){
		console.log('任务已全部完成');
	}
})({});

function checkRepeatValues(codeList){
	const list = codeList.filter(function(code){
		if(this.has(code))return true;
		this.add(code);
	}, new Set());
	if(list.length <= 0)return;
	console.group('重复的编号:');
	for(let code of list){
		console.log(code);
	}
	console.groupEnd();
}

function showTaskInfo(price, count, codeList){
	console.group('扫码任务:');
	for(let code of codeList){
		console.log(`编号: ${code} 金额: ${price} 次数: ${count}`);
	}
	console.groupEnd();
}

function main(price, count, codes){
	showIP();
	const codeList = codes.match(/\d+/g);
	checkRepeatValues(codeList);
	showTaskInfo(price, count, codeList);
	const taskList = codeList.map(v => Array(count).fill(v)).flat();
	require('http').createServer(({url}, response) => {
		if(url === '/qh' && taskList.length > 0){
			const code = taskList.shift();
			response.end(JSON.stringify(
				{SMS:[
					{'商户名称':code},
					{'商户链接':encodeURIComponent(`https://nxt.nongxinyin.com/buybal-api/v1.0/cashier/initializWithAmount/${code}/${price}`)},
					{'扫码次数':1}
				]}
			));
			return;
		}
		if(url.startsWith('/fh?')){
			print(url.split('?')[1], count, codeList.length);
		}
		response.end();
	}).listen(80);
}

module.exports = main;
