'use strict';

const load = require('../net/load');
const fs = require('fs');

const atob = v => Buffer.from(v, 'base64').toString();
const printPercent = (a, b) => Math.round(100 * a / b) + '%';

function strencode(bm){
	const bn = "9804udor9e3cxBIVHeFE7RUD3V4TEIuilFrUtddbxz8UFx6wL69BcaQIS27WK91zoQ61JZ4yvGu4BV6YP7nPVfGxH0kTd46Hyzse68GdNS7xMFvOisNnrrjk7vGgj/ED3EV4R5NyMW9Xos29tj/L";
	return atob(atob(bm).split('').map((v, i) => String.fromCharCode(v.charCodeAt() ^ bn.charCodeAt(i % bn.length))).join(''));
}

async function download(download_code){
	const response = await load('https://down.com/link/', {search:{
		download_code, submit_code: '点击下载'
	}, autoRead:false, useCookieFlag:false});
	const content_length = response.headers['content-length'];
	const filename = (response.headers['content-disposition'] || ';="error.txt"').split(';')[1].split('=')[1].slice(1, -1);
	if(fs.existsSync(filename))return;
	response.on('data', (total => data => {
		total += data.length;
		console.log(filename, content_length, printPercent(total, content_length));
	})(0));
	response.pipe(fs.createWriteStream(filename));
}

async function download_m3u8(path){
	const m3u8 = /src='(.+?)'/.exec(
		strencode(/strencode\("([^"]+)"\)/.exec(
			await load(root)
		)[1])
	)[1];
	const index = m3u8.lastIndexOf('/') + 1;
	const prefix = m3u8.slice(0, index);
	const filename = m3u8.slice(index).replace('m3u8', 'mp4');
	const data = await load(m3u8, {responseType: 'text'});
	const taskList = data.match(/^.+\.ts$/gm).map(v => prefix + v).map((v, i) => load(v, {onProgress(size){
		console.log(i, printPercent(size, this.headers['content-length']));
	}}));
	fs.writeFileSync(filename, Buffer.concat(await Promise.all(taskList)));
}

async function main(){
	console.log(await download_m3u8(root))
}

main();
