
const load = require('../net/load');

const link = 'https://free-api.heweather.net/s6/';
const key = 'c3a820f5337f4fbdb2bf72eeff9975e8';

function weather_now(location='auto_ip'){
	return load(link + 'weather/now', {query:{location,key}});
}
function weather_forecast(location='auto_ip'){
	return load(link + 'weather/forecast', {query:{location,key}});
}
function air_now(location='auto_ip'){
	return load(link + 'air/now', {query:{location,key}});
}

async function main(){
	console.log(JSON.stringify(await weather_now()))
	console.log(JSON.stringify(await weather_forecast()))
	console.log(JSON.stringify(await air_now()))
}

main();

const create = function(){
	const fetchJson = (f => v => fetch(v).then(f))(v => v.json());
	const toSearch = v => '?' + new URLSearchParams(v);
	return key => {
		const getLocation = location => fetchJson(`https://geoapi.qweather.com/v2/city/lookup` + toSearch({location, key}));
		const fetchWeather = type => location => fetchJson(`https://devapi.qweather.com/v7/${type}` + toSearch({location, key}));
		return {
			getLocation,
			weather_now: fetchWeather('weather/now'),
			weather_7d: fetchWeather('weather/7d'),
			air_now: fetchWeather('air/now'),
		}
	}
}();


