/*
{
	"name": "name",
	"description": "description",
	"version": "1.0.0",
	"main": "main.html",
	"inject_js_end":"index.js",
	"node-remote":"<all_urls>",
	"chromium-args": "--mixed-context --enable-node-worker --enable-unsafe-webgpu",
	"window": {
		"width": 1420,
		"height": 760,
		"frame": true,
		"position": "center"
	}
}
*/
const sleep = timeout => new Promise(resolve => setTimeout(resolve, timeout));

function hideElement(selector){
	for(let element of document.querySelectorAll(selector)){
		element.style.display = 'none';
	}
}

const fs = require('fs')

function savePng(path, clip){
	return new Promise(resolve => {
		nw.Window.get().captureScreenshot({fullSize:true, format:'png', clip:{...clip, scale:1}}, (error, data) => {
			fs.writeFileSync(path, Buffer.from(data, 'base64'))
			resolve();
		})
	});
}

void async function(){
	await sleep(1000);
	hideElement('div#page-footer')
	hideElement('div.page-container div[class^=index_bottom-bar]')
	hideElement('div.page-container div[class^=index_risk-bar]')
	hideElement('div.page-container div[class^=index_layout-nav]')
	hideElement('div.page-container div[class^=index_tag-nav-root]')
	hideElement('div.page-container div[class^=layout_company-dim-map]')
	hideElement('div.page-container div[class^=index_seo-footer]')
	hideElement('div.page-container div.dim-section > div[data-dim]:not([data-dim=baseInfo],[data-dim=npoBaseInfo],[data-dim=report])')
	await sleep(1000);

	const input = document.querySelector('input[type=text]')
	const companyName = input.value;
	const fileName = `./images/${companyName}.png`;

	if(!fs.existsSync(fileName)){
		const root = document.querySelector('div[class^=layout_company-root]')
		const {x, y, width, height} = root.getBoundingClientRect()
		await savePng(fileName, {x, y, width, height})
	}

	const companyIndex = companyList.indexOf(companyName);

	if(companyIndex < 0){
		window.alert(`${companyName} not found!`)
		return;
	}

	if(companyIndex == companyList.length - 1){
		window.alert('task done!')
		return;
	}

	input.value = companyList[companyIndex + 1];

	const submitBtn = input.parentElement.nextElementSibling;
	submitBtn.click();
}();

const companyList = [

];