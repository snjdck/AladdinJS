
const load = require('../net/load');

const toPromise = fn => new Promise(resolve => fn(resolve));
const match = (text, pattern, mapFn) => text.match(new RegExp(pattern, 'g')).map(v => mapFn(new RegExp(pattern).exec(v)));

function listen(fn){
	process.stdin.on('data', data => {
		process.stdin.removeAllListeners('data');
		data = data.toString().trim();
		if(data == 'exit')process.exit();
		fn(data);
	});
}

const pattern = /<a href="\/vod\/(\d+)\/".+?<\/a>/.source;

function fetchLinks(data){
	let dict = Object.create(null);
	match(data, pattern, v => v.slice(0, 2)).forEach(v => dict[v[1]] = v[0]);
	return Object.entries(dict).sort((a, b) => b[0] - a[0]).map(v => v[1]);
}

async function main(){
	let data = await load('http://www.beiwo888.com');
	console.log(fetchLinks(data));
	for(;;){
		console.log('input vod number:');
		let index = await toPromise(listen);
		if(/search:/.test(index)){
			let key = /search:\s*(.+)/.exec(index)[1];
			let data = await load('http://www.beiwo888.com/index.php?s=vod-search', {search:{typeid:2,wd:key}});
			console.log(fetchLinks(data))
			continue;
		}
		let data = (await load(`http://www.beiwo888.com/vod/${index}/`)).toString();
		let result = /var GvodUrls3 = "(.+?)";/.exec(data);
		if(result){
			let list = result[1].match(/.+?\$###/g).map(v => v.slice(v.indexOf('$')+1, -4));
			console.log(list.join('\n'))
		}
	}
}

main();



