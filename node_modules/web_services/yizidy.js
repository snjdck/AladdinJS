'use strict';

const {URL} = require('url');
const load = require('../net/load');

const root = 'http://www.yizidy.com';

async function main(id, index=0){
	let data = await load(`${root}/vod/${id}/play.html`);
	let a = /<!--播放开始-->(.+?)<!--播放结束-->/s.exec(data)[1];
	let list = a.match(/<script .+?<\/script>/g);
	let c = /<script language="javascript">(.+?)<\/script>/.exec(list.shift())[1];
	c = JSON.parse(c.slice(c.indexOf(`'`)+1, c.lastIndexOf(`'`)));
	const {playurls} = c.Data.find(v => v.playname == 'down');
	let url = playurls[index][1];
	return url;
	data = await load(url);
	data = /^.+\.m3u8/m.exec(data)[0];
	url = url.replace('index.m3u8', data);
	data = await load(url);
	//let timeList = data.toString().match(/#EXTINF:(\d+\.\d+),$/gm).map(v => Number(v.slice(8, -1)))
	let waitList = data.toString().match(/^.+\.ts/gm).map(v => url.replace('index.m3u8', v));
	//console.log(timeList.reduce((a, b) => a + b, 0));
	let loadCount = 0;
	let sizeList = await Promise.all(waitList.map(v => 
		new Promise(resolve => {
			require(new URL(v).protocol.slice(0, -1)).request(v, {method:'HEAD'}, response => {
				console.log(waitList.length, ++loadCount, response.headers['content-length'])
				resolve(response.headers['content-length']);
			}).end();
		})
	));
	return [waitList, sizeList.map(Number)];
}

module.exports = main;
