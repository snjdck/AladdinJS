
function runAction(target, action){
	let cancelFlag = false;
	const promise = new Promise((resolve, reject) => {
		const g = action(target);
		if(globalThis.document){
			const t = document.timeline.currentTime;
			void function f(timestamp){
				if(cancelFlag)return reject();
				const {done} = g.next(timestamp - t);
				if(done)resolve();else requestAnimationFrame(f);
			}();
		}else{
			const t = performance.now();
			void function f(){
				if(cancelFlag)return reject();
				const {done} = g.next(performance.now() - t);
				if(done)resolve();else setTimeout(f, 100);
			}();
		}
	});
	promise.cancel = () => {cancelFlag = true};
	return promise;
}

const Spawn = (actions, count) => function*(target){
	const list = Array.from(actions, action => action(target));
	count = count ?? list.length;
	let lastV = 0;
	const f = (v, g) => v + g.next(lastV).done;
	while(list.reduce(f, 0) < count){
		lastV = yield;
	}
}

const Sequence = actions => function*(target){
	let offset = 0;
	let lastV = 0;
	for(let action of actions){
		for(let g = action(target); !g.next(lastV - offset).done;){
			lastV = yield;
		}
		offset = lastV;
	}
}

const Repeat = function(){
	const genN = function*(value, count){for(let i=0; i<count; ++i)yield value};
	return (action, count=Infinity) => Sequence(genN(action, count));
}();

const CallFunc = f => function*(target){
	const action = f(target);
	if(action instanceof Function)yield* action(target);
}

const Delay = duration => function*(){
	for(let lastV=0; lastV<duration;){
		lastV = yield;
	}
}

const ActionBuilder = function(){
	const linear = v => v;
	const interpolate = function([a, b]){return a + (b - a) * this};
	const sub = v => v[1] - v[0];
	return (getFn, setFn) => value => function*(target){
		const info = getFn(target, value);
		const ease = value.ease ?? linear;
		const duration = value.duration ?? Math.hypot(...info.map(sub)) / value.speed;
		for(let lastV=0; lastV<duration;){
			lastV = yield;
			setFn(target, info.map(interpolate, ease(Math.min(1, lastV / duration))));
		}
	}
}();

function nearestRotation(value, base=0, unit=180){
	const unit2 = unit * 2;
	if(value > base){
		while(value - base > unit)value -= unit2;
	}else{
		while(base - value > unit)value += unit2;
	}
	return value;
}

module.exports = {
	runAction,
	Spawn, Sequence,
	Repeat, CallFunc,
	Delay, ActionBuilder,
	nearestRotation,
};
