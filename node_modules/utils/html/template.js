'use strict';

const escape = require('./escape');

const pattern = /<%(=|!)?(.*?)%>/gs;
const join = (generator, char) => Array.from(generator).join(char);

function* _template(input){
	let lastIndex = 0;
	for(let info of input.matchAll(pattern)){
		yield `yield ${JSON.stringify(input.slice(lastIndex, info.index))};`;
		lastIndex = info.index + info[0].length;
		let text = info[2];
		switch(info[1]){
			case '=': text = `escape(String(${text}))`;//fallthrough
			case '!': text = `yield ${text};`;break;
		}
		yield text;
	}
	yield `yield ${JSON.stringify(input.slice(lastIndex))};`;
}

function template(input){
	const code = join(_template(input), '\n');
	const handler = Function('escape', `return function*(){with(this){${code}}}`)(escape);
	return self => join(handler.call(self), '');
}

module.exports = template;
