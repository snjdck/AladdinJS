'use strict';

const _escape = require('./escape');

const _eval = eval;
const pattern = /<%(=|!|#|)([^]*?)%>/;
const builtin = {escape:{value:_escape}};

const join = (generator, char) => Array.from(generator).join(char);

function* _template(input){
	for(;;){
		let info = pattern.exec(input);
		let head = info ? input.slice(0, info.index) : input;
		if( head)yield `yield ${JSON.stringify(head)};`;
		if(!info)break;
		input = input.slice(info.index + info[0].length);
		let text = info[2];
		switch(info[1]){
			case '=': text = `escape(String(${text}))`;//fallthrough
			case '!': text = `yield ${text};`;break;
			case '#': continue;
		}
		yield text;
	}
}

function template(input){
	const code = join(_template(input), '\n');
	const handler = _eval(`(function*(){with(this){${code}}})`);
	return (self=null) => join(handler.call(Object.create(self, builtin)), '');
}

module.exports = template;
