'use strict';

function Updater0(updateFn, init){
	let value = init;
	let isUpdating = false;
	const setValue = v => value = v;
	const onError = () => value = init;
	const onUpdate = () => isUpdating = false;
	return () => {
		if(!isUpdating){
			isUpdating = true;
			updateFn().then(setValue, onError).finally(onUpdate);
		}
		return value;
	}
}

function Updater1(getUpdateFn, getInit){
	const dict = new Map();
	return key => {
		if(!dict.has(key)){
			dict.set(key, Updater0(getUpdateFn(key), getInit(key)));
		}
		return dict.get(key)();
	}
}

exports.Updater0 = Updater0;
exports.Updater1 = Updater1;
