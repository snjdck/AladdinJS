'use strict';

const limitSend = (sendFn, limit=20) => async data => {
	for(let v of cut(data, limit)){
		await sendFn(v);
	}
}

function*cut(data, limit=20){
	const length = data instanceof ArrayBuffer ? data.byteLength : data.length;
	if(length <= limit)return yield data;
	let offset = 0;
	do{
		yield data.slice(offset, offset + limit);
		offset += limit;
	}while(offset < length);
	//}while(length - offset > limit);
	//yield data.slice(offset);
}

function*cut_json(data, limit){
	const length = data.length;
	for(let i=0,j=0; i<length; i=j){
		for(let n=0; n<=limit; ++j){
			n += j < length ? '\r\n"\t\\'.includes(data.charAt(j)) ? 2 : 1 : limit;
		}
		yield data.slice(i, --j);
	}
}

exports.limitSend = limitSend;
exports.cut_json = cut_json;
exports.cut = cut;
