'use strict';

function TaskExecutor(maxCount=1){
	let taskList = [];
	let runCount = 0;
	function doRun(){
		if(taskList.length <= 0 || runCount >= maxCount)return;
		++runCount;
		const [task, resolve, reject] = taskList.shift();
		task().finally(onRun).then(resolve, reject);
	}
	const onRun = () => doRun(--runCount);
	return task => new Promise((resolve, reject) => doRun(taskList.push([task, resolve, reject])));
}

const TaskQueue = last => task => last = last ? last.then(task) : task();

function createTask(handler, maxCount=1){
	const fn = TaskExecutor(maxCount);
	return (...args) => fn(() => handler(...args));
}

const execList = (executor, fn) => list => Promise.all(Array.from(list.map(v => () => fn(v)), executor));

exports.TaskExecutor = TaskExecutor;
exports.TaskQueue = TaskQueue;
exports.createTask = createTask;
exports.execList = execList;
