'use strict';

const cast = function(){
	function addKV(d, k, v){
		if(!v)return;
		if(!(k in d)){
			d[k] = v;
		}else if(Array.isArray(d[k])){
			d[k].push(v);
		}else{
			d[k] = [d[k], v];
		}
	}
	return ({attributes, childNodes}) => {
		if(attributes.length == 0 && childNodes.length == 0)return;
		if(attributes.length == 0 && childNodes.length == 1 && childNodes[0].nodeType == Node.TEXT_NODE)return childNodes[0].data;
		const json = Object.create(null);
		for(let attr of attributes){
			json[attr.name] = attr.value;
		}
		for(let node of childNodes){
			if(node.nodeType == Node.ELEMENT_NODE){
				addKV(json, node.localName, cast(node));
			}else if(node.nodeType == Node.TEXT_NODE){
				addKV(json, node.nodeName, node.data);
			}
		}
		return json;
	}
}();

module.exports = cast;
