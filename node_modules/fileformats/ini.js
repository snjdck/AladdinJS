"use strict";

const {createDictGetter} = require('utils/cache');

const PATTERN_FIELD		= /^\[(.*)\]/;
const PATTERN_KEY_VALUE	= /([^=]+)=(.*)/;
const PATTERN_COMMENT	= /^;.*/;

const newField = () => ({});

function decode(source){
	const result = {};
	const getField = createDictGetter(newField, result);
	let field=result, info;
	for(let line of source.split('\r\n')){
		if(PATTERN_COMMENT.test(line))continue;
		info = PATTERN_KEY_VALUE.exec(line);
		if(info){
			field[info[1].trim()] = info[2].trim();
			continue;
		}
		info = PATTERN_FIELD.exec(line);
		if(info){
			field = getField(info[1].trim());
		}
	}
	return result;
}

exports.decode = decode;