'use strict';

const watchFile = require('./watchFile');
const {WebSocketServer} = require('../net/websocket');
const EventSource = require('../net/EventSource');

module.exports = function(filename, port, host='0.0.0.0'){
	const socketList = [];
	/*
	WebSocketServer((socket, path) => {
		socketList.push(socket);
		socket.on('close', () => socketList.splice(socketList.indexOf(socket), 1));
	}, port, host);
	//*/
	EventSource({host, port})('/', response => {
		socketList.push(response);
		return () => socketList.splice(socketList.indexOf(response), 1);
	});
	watchFile(filename, function(){
		let dirtyFlag = false;
		return function(){
			if(dirtyFlag)return;
			dirtyFlag = true;
			setTimeout(function(){
				dirtyFlag = false;
				//socketList.forEach(socket => socket.send('reload'));
				socketList.forEach(response => response.write('data: reload\n\n'));
			}, 10);
		}
	}());
}

/*
	<script>
		let ws = new WebSocket('ws://127.0.0.1:81');
		ws.onmessage = () => location.reload(true);
		ws.onclose = evt => console.log('closed', evt);
		setInterval(() => ws.send('ping'), 30 * 1000);
	</script>
	<script>
		let es = new EventSource('http://127.0.0.1:81');
		es.onmessage = () => location.reload(true);
	</script>
*/
