'use strict';

const {parentPort, workerData} = require('worker_threads');
const compile = require('./arduino_compiler');

const mcu = process.argv[2];//atmega2560, atmega328p

const parseHEX = data => Buffer.from(Array.from(data.trim()
	.split(/\s+/)
	.map(line => line.slice(9, -2))
	.join('')
	.match(/\w{2}/g),
	v => parseInt(v, 16)
));

const hex_data = compile(mcu, workerData, avr_root, [
	root + 'includes/cores/arduino',
	root + 'includes/variants/' + (mcu == 'atmega2560' ? 'mega' : 'standard'),
], [
	root + 'libs/core.a'
].map(v => v.replace('.a', `_${mcu}.a`)));
const bin_data = parseHEX(hex_data.toString());

parentPort.postMessage(bin_data, [bin_data.buffer]);
