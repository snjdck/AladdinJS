'use strict';

const Vulkan = require('./Vulkan');
const ClassifierFactory = require('./helper/ClassifierFactory');

const classifyMaterial = ClassifierFactory(drawUnit => drawUnit.material.constructor, ([a], [b]) => a.order - b.order);
const classifyMesh = ClassifierFactory(drawUnit => drawUnit.entity.mesh);

class DrawUnitBucket
{
	constructor(){
		this.list = [];
	}

	clear(){
		this.list.length = 0;
	}

	draw(){
		for(const [materialType, entityList] of classifyMaterial(this.list)){
			Vulkan.renderPassEncoder.setPipeline(materialType.pipeline);
			if(!materialType.useMeshFlag){
				materialType.draw(entityList);
				continue;
			}
			for(const [mesh, entityList2] of classifyMesh(entityList)){
				Vulkan.currentMesh = mesh;
				materialType.setVertexBuffer(mesh);
				materialType.setIndexBuffer(mesh);
				materialType.draw(entityList2);
			}
		}
		return this;
	}

	add(element){
		this.list.push(element);
	}
}

module.exports = DrawUnitBucket;
