'use strict';

const Material = require('./Material');
const TextureMaterial = require('./TextureMaterial');

const maxCountPerDraw = 100;

const pipeline = TextureMaterial.pipeline.clone({
	groups: v => [
		v[0],
		[v[1][0], {name:'boneStateList', binding:1, visibility:GPUShaderStage.VERTEX, buffer:{}}],
		v[2]
	],
	vertex:{entryPoint: 'mainBillboard'},
	fragment:{
		targets:[{
			format: 'bgra8unorm',
			blend: {
				color:{srcFactor: 'one', dstFactor: 'one-minus-src', operation: 'add'},
				alpha:{srcFactor: 'src-alpha', dstFactor: 'one-minus-src-alpha', operation: 'add'}
			}
		}]
	},
	depthStencil: {depthWriteEnabled: false},
	primitive: {topology: 'triangle-strip'}
}).desc;

class BillboardMaterial extends Material.Subclass(pipeline, [Material.Utils.groupTexture]){
	static maxCountPerDraw = maxCountPerDraw;
	static onDraw(drawUnitList, texture, renderPassEncoder){
		this.setResources(renderPassEncoder, {
			'worldMatrixList': {buffer:drawUnitList},
			'boneStateList': {buffer:pointSize},
			'baseTexture': texture.createView()
		});
		renderPassEncoder.draw(4, drawUnitList.length);
	}
	constructor(texture, width, height){
		super();
		this.texture = texture;
	}
}

const pointSize = new Float32Array([16, 32]);

module.exports = BillboardMaterial;
