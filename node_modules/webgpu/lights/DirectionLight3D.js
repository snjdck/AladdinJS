"use strict";

const {DepthRenderTarget} = require("../rendertargets");
const {DepthMaterial} = require("../materials");
const Light3D = require("./Light3D");
const {Camera3D, Lens, ClearFlags} = require("../cameras");
const WebGL = require('../WebGL');

class DirectionLight3D extends Light3D
{
	constructor(){
		super();

		let w = 2048;
		let h = 2048;

		let lens = Lens.OrthoLH(w, h, -1000, 1000);
		let camera = new Camera3D(lens);
		let rotation = camera.transform.rotation;
		rotation.rotateAxisX(120 * Math.PI / 180);
		rotation.rotateAxisZ(-90 * Math.PI / 180);
		camera.rotation = rotation;
		camera.clearFlags = ClearFlags.Depth();
		camera.renderTarget = new DepthRenderTarget(w, h);
		this.camera = camera;
	}

	drawShadowMap(root){
		this.camera.render(root, collectShadowUnits);
	}
}

function collectShadowUnits(node){
	if(node.castShadow && node.drawUnitCache){
		let drawUnit = node.drawUnitCache.getOut();
		drawUnit.material = DepthMaterial.new();
		this.addDrawUnit(drawUnit);
	}
}

module.exports = DirectionLight3D;