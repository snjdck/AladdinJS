'use strict';

const Vulkan = require('../Vulkan');
const BitmapQueue = require('opengl/renderers/BitmapQueue');
const traverseTree = require('utils/traverseTree');
const BufferBindGroup = require('../helper/BufferBindGroup');

const pipelineDesc = {
	layout: ['0', '3'],
	vertex: {
		module: 'vertex_2d',
		buffers: [{
			arrayStride: 22 << 2,
			stepMode: 'instance',
			attributes: ['float32x3', 'float32x3', 'float32x4', 'float32x4', 'float32x4', 'float32x4']
		}]
	},
	fragment: {
		module: 'fragment_2d',
		targets:[{
			format: 'bgra8unorm',
			writeMask: 0xF,
			blend: ['transparent']
		}]
	}
};

class Render2D
{
	constructor(){
		this.handlerDict = {};
		this.bitmapQueue = new BitmapQueue(v => v.texture.getRawAsset());
		Vulkan.bindRenderPipeline(this, pipelineDesc);
		this.mvpGroup = new BufferBindGroup([[GPUBufferUsage.UNIFORM, 2 * 4, true]], buffer => {
			new Float32Array(buffer.getMappedRange()).set([2 / Vulkan.canvas.width, -2 / Vulkan.canvas.height]);
			buffer.unmap();
			return [['0', {buffer}, Vulkan.getSampler('linear_clamp')]];
		});
	}

	calcKey(type, mode){
		return type + '@' + mode;
	}

	register(type, handler, mode=''){
		this.handlerDict[this.calcKey(type, mode)] = handler;
	}

	tryAdd(target, mode=''){
		const type = target.type;
		const handler = this.handlerDict[this.calcKey(type, mode)];
		if(!handler)return;
		handler.call(target, mode, type);
	}

	add(target){
		this.bitmapQueue.add(target);
	}

	collect(root, includeRoot=true){
		traverseTree.call(this, root, onCollect, includeRoot);
	}

	prepareToDraw(){
		const {renderPassEncoder} = Vulkan;
		renderPassEncoder.setPipeline(this.pipeline);
		renderPassEncoder.setBindGroup(0, this.mvpGroup.getBindGroup());
	}

	draw(){
		this.bitmapQueue.draw(onBatchDraw2D, this).clear();
	}
}

function onBatchDraw2D(instanceList){
	Vulkan.renderPassEncoder.setBindGroup(1, Vulkan.createBindGroup('3', instanceList[0].texture.getRawAsset()));
	Vulkan.vertexBufferMgr.draw(instanceList);
}

function onCollect(item){
	if(!item.visible)return true;
	const {filter} = item;
	if(filter){
		this.add(filter);
		return true;
	}
	this.tryAdd(item);
}

module.exports = Render2D;
