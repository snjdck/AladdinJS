'use strict';

const DisplayObject2D = require('../DisplayObject2D');
const DisplayObject3D = require('../DisplayObject3D');
const {CommandEncoder} = require('../core/CommandEncoder');
const {fetchTextures} = require('../Vulkan/resource');

class View3D
{
	constructor(){
		this.scene3d = new DisplayObject3D();
		this.scene2d = new DisplayObject2D();

		this.scene3d._scene = this;
		this.scene2d._scene = this;
	}

	render(device, canvas){
		//console.time('render')
		const {scene3d, scene2d} = this;

		scene3d.camera.collectDrawUnits(scene3d);
		scene2d.camera.collectDrawUnits(scene2d);

		for(let commandEncoder of CommandEncoder(device, canvas)){
			const ctx = fetchTextures(canvas, device);
			for(let renderPassEncoder of commandEncoder.beginRenderPass('load+store;load+discard;load+discard', ctx.colorView, ctx.depthStencilView)){
				renderPassEncoder.setViewportToCanvas();
				scene3d.camera.draw(renderPassEncoder, ctx);
			}
			for(let renderPassEncoder of commandEncoder.beginRenderPass('load+store', ctx.colorView)){
				renderPassEncoder.setViewportToCanvas();
				scene2d.camera.draw(renderPassEncoder);
			}
			commandEncoder.copyTextureToTexture(
				{texture:ctx.colorTexture},
				{texture:commandEncoder.getCurrentTexture()},
				canvas
			);
		}
		//console.timeEnd('render')
	}
}

module.exports = View3D;
