const {timeline} = document;//performance.now();
const {ObjectPool} = require('utils/gc');

function nextPowerOf2(x){
	let value = 1;
	while(value < x)value <<= 1;
	return value;
}

const TexturePool = function(){
	const queryFn1 = function(v){return v.width >= this.width && v.height >= this.height;}
	const queryFn2 = function(v){return v.width == this.width && v.height == this.height;}
	const wrapNewFn = newFn => (query, device) => newFn({...query, width:nextPowerOf2(query.width), height:nextPowerOf2(query.height)}, device);
	return (newFn, adjustFlag=true) => adjustFlag ? ObjectPool(wrapNewFn(newFn), queryFn1) : ObjectPool(newFn, queryFn2);
}();

function mainLoop(handler){
	let zero = timeline.currentTime;
	let prev = zero;//timeElapsed
	requestAnimationFrame(function f(timestamp){
		handler(timestamp - prev, timestamp - zero);
		requestAnimationFrame(f);
		prev = timestamp;
	});
}

exports.mainLoop = mainLoop;
exports.TexturePool = TexturePool;
