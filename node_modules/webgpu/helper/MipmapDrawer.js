'use strict';

const {CommandEncoder, beginRenderPass} = require('./CommandEncoder');
const Pipeline = require('../materials/Pipeline');

const drawMipmap = function(){
	const drawFn = Pipeline.Blit([[
		{name:'g_sampler', sampler:{}, default:{minFilter:'linear'}},
		{name:'baseTexture', texture:{}},
	]], {format: 'bgra8unorm'}, `@fragment{return textureSample(baseTexture, g_sampler, uv);}`);
	return (device, texture) => {
		for(let commandEncoder of CommandEncoder(device)){
			for(let i=1, n=texture.mipLevelCount; i<n; ++i){
				for(let renderPassEncoder of beginRenderPass('[0,0,0,0]+store', commandEncoder, texture.createView({baseMipLevel:i,mipLevelCount:1}))){
					drawFn(renderPassEncoder, {baseTexture: texture.createView({baseMipLevel:i-1,mipLevelCount:1})});
				}
			}
		}
	}
}();

exports.drawMipmap = drawMipmap;
