'use strict';

let {execFile} = require('child_process');
let {readFile, writeFile} = require('fs');
const promisify = require('utils/function/promisify');
const TaskQueueFactory = require('utils/task');
const {bodyParser} = require('net/HttpServer');

readFile = promisify(readFile, 1);
writeFile = promisify(writeFile);
execFile = promisify(execFile);



const enqueue = TaskQueueFactory(async([code, response])=>{
	await writeFile(inoPath, code);
	await execFile(arduino_exe, ['--verify', '--board', 'arduino:avr:uno', '--pref', `build.path=${libdir}`, '--preserve-temp-files', inoPath]);
	const data = await readFile(hexPath);
	response.setHeader('Access-Control-Allow-Origin', '*');
	response.setHeader('Content-Type', 'text/plain');
	response.setHeader('Content-Length', data.length);
	response.end(data);
});

module.exports = bodyParser.raw((request, response) => enqueue([request.body, response]));
