'use strict';

let {execFile} = require('child_process');
let {readFile, writeFile} = require('fs');
const promisify = require('utils/function/promisify');
const {readData} = require('net/HttpServer');

readFile = promisify(readFile, 1);
writeFile = promisify(writeFile);
execFile = promisify(execFile);
const listenEvt = promisify(readData);



module.exports = async function(request, response){
	const body = await listenEvt(request);
	await writeFile(inoPath, body);
	await execFile(arduino_exe, ['--verify', '--board', 'arduino:avr:uno', '--pref', `build.path=${libdir}`, '--preserve-temp-files', inoPath]);
	const data = await readFile(hexPath);
	response.setHeader('Access-Control-Allow-Origin', '*');
	response.setHeader('Content-Type', 'text/plain');
	response.setHeader('Content-Length', data.length);
	response.end(data);
}
