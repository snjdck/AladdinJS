'use strict';

const needBrackets = require('js/needBrackets');
const {tab, untab} = require('utils/text');

const Arduino = {
	ORDER_ATOMIC: 0,
	ORDER_HIGH: 1,
	ORDER_EXPONENTIATION: 2,
	ORDER_UNARY: 3,
	ORDER_MULTIPLICATIVE: 4,
	ORDER_ADDITIVE: 5,
	ORDER_SHIFT: 6,
	ORDER_RELATIONAL: 7,
	ORDER_EQUAL: 8,
	ORDER_BIT_AND: 9,
	ORDER_BIT_XOR: 10,
	ORDER_BIT_OR: 11,
	ORDER_AND: 12,
	ORDER_OR: 13,
	ORDER_NONE: 99,
	END: ';\n',
	commentStart:'//',
	needBrackets: needBrackets(v => 100 - v, v => v == Arduino.ORDER_EXPONENTIATION || v == Arduino.ORDER_UNARY),
	init(){
		this.initStage();
		this.varType = {
			"Number": 'double',
			"String": 'String',
			"Boolean": 'bool',
			"Array": 'LinkedList',
			"": 'double',
		};
	},
	onCodeMissed(text, v=0){
		text = text.replace(/\*\//g, '*\\/');
		return [`${v}/*${text}*/`, this.ORDER_ATOMIC];
	},
	onGenVarDef(new_name, name, type){
		return `${this.varType[type]} ${new_name}` + `;\t//${name}\n`;
	},
	genSensorKey(type, name, pin='0'){
		const suffix = pin.split('_').pop();
		const key = name.startsWith(suffix.toLowerCase()) ? name : name + `_` + suffix;
		this.addInclude(`#include<${type}.h>`);
		this.addVarDef(`${type} ${key}(${pin});\n`);
		return key;
	},
	finish(workspace, loopCode, funcBlockList){
		funcBlockList.forEach(this.blockToCode, this);
		this.collectVarDefs(workspace.variables?.variable);
		this.addStage(4, '%setup-b%');
		this.addStage(6, '%setup-e%');
		this.addStage(7, '%loop-b%');
		this.addStage(8, loopCode);
		this.addStage(9, '%loop-e%');
		return this.genStageCode().replace(/%(setup|loop)-b%(.+)%\1-e%/gs, (_, n, v) => `void ${n}(){\n${tab(v.trim())}\n}\n`);
	},
	workspaceToCode(workspace){
		if(!workspace.block)return '';
		const blockList = Array.isArray(workspace.block) ? workspace.block : [workspace.block]
		const funcBlockList = blockList.filter(block => ['procedures_defreturn', 'procedures_defnoreturn', 'procedures_def'].includes(block.type));
		this.init();
		const loopCode = blockList.filter(block => block.data === 'isEventBlock').map(this.blockToCode, this).join('');
		return this.finish(workspace, loopCode, funcBlockList);
	}
}

module.exports = Arduino;