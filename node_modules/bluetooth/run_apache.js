'use strict';

const fs = require('fs');
const options = {
	key: fs.readFileSync('./server.key'),
	cert: fs.readFileSync('./server.pem')
};

const autopack = require('../build_tools/autopack');
const watchFile = require('../build_tools/watchFile');
const {HttpServer, EventSource, StaticFile, Redirect} = require('../net/HttpServer');

const root = '../app_public';

autopack(__dirname, 'main.js', root, '--debug');

const socketList = [];
watchFile(root, () => socketList.forEach(response => response.write('data: reload\n\n')));

HttpServer({
	protocol: 'https',
	port: 443,
	options
}, [
	EventSource({
		'/reload': (response, params) => {
			socketList.push(response);
			return () => {
				console.log('client close');
				socketList.splice(socketList.indexOf(response), 1);
			}
		}
	}),
	StaticFile(root),
])

HttpServer(null, [
	Redirect(request => 'https://192.168.0.6' + request.url),
])
