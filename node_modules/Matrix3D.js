"use strict";

/*
[x, y, z, 1] * matrix4x4 * matrix4x4
*/
const Quaternion = require("./Quaternion");
const Vector3D = require("./Vector3D");

const tempVector = new Vector3D();

/* 缩放,旋转,偏移 */
class Matrix3D{
	static concat(left, right, result){
		let {rotation:rotationL, translation:translationL} = left;
		let {rotation:rotationR, translation:translationR} = right;
		rotationR.rotateVector(translationL, tempVector);
		translationR.add(tempVector, result.translation);
		rotationR.prepend(rotationL, result.rotation);
	}

	static invert(matrix, result){
		let {rotation, translation} = result;
		matrix.rotation.negate(rotation);
		rotation.rotateVector(matrix.translation, translation);
		translation.negate();
	}

	constructor(){
		this.rotation = new Quaternion();
		this.translation = new Vector3D();
	}

	identity(){
		this.translation.setTo(0, 0, 0);
		this.rotation.setTo(0, 0, 0, 1);
	}
	
	copyFrom(source){
		this.translation.copyFrom(source.translation);
		this.rotation.copyFrom(source.rotation);
	}

	append(other, result=this){
		Matrix3D.concat(this, other, result);
	}
	
	prepend(other, result=this){
		Matrix3D.concat(other, this, result);
	}
	
	invert(result=this){
		Matrix3D.invert(this, result);
	}

	upload(gl, address){
		this.rotation.toMatrix(buffer, this.translation);
		gl.uniformMatrix4fv(address, false, buffer);
	}
}

const buffer = new Float32Array(16);

module.exports = Matrix3D;